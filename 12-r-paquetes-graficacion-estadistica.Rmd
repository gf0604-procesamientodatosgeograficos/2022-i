# (PART) III. Graficación estadística en R {-}

# Paquetes de R para graficación estadística

## Trabajo previo

### Lecturas
Chang, W. (2018). *R graphics cookbook: Practical recipes for visualizing data*. O’Reilly. https://r-graphics.org/

## Resumen
R proporciona una gran cantidad de funciones para la elaboración de gráficos estadísticos. En este capítulo, se describen algunos de los paquetes que contienen estas funciones.

## Paquetes
Se presentan ejemplos de los paquetes `graphics`, `ggplot2` y `plotly`. 

- [graphics](http://search.r-project.org/R/library/graphics/html/graphics-package.html): forma parte de la instalación base de R. Es muy versátil y permite construir una gran cantidad de tipos de gráficos. Sin embargo, estos graficos son estáticos y no ofrecen posibilidades de interacción con el usuario.
- [ggplot2](https://ggplot2.tidyverse.org/): es un sistema para la creación declarativa de gráficos, basado en el libro [*The Grammar of Graphics*, de Wilkinson et al.](https://www.springer.com/gp/book/9780387245447). El programador proporciona los datos, indica cuales variables mapear a las propiedades visuales (estéticas o *aesthetics*) de las geometrías y `ggplot2` trata de encargarse del resto de los detalles.
- [plotly R](https://plotly.com/r/): es una biblioteca para gráficos interactivos que forma parte de la familia de [Plotly](https://plotly.com/), la cual incluye bibliotecas para otros lenguajes como JavaScript, Python, Julia, F# y MATLAB. Es adecuada, por ejemplo, cuando los gráficos van a utilizarse en la Web. Incluye una función llamada `ggplotly()` que permite convertir gráficos de `ggplot2` a `plotly`.

## Opciones generales
Se configuran opciones generales de la sesión R.

```{r opciones-generales}
# Configuración de la notación científica
options(scipen = 7)
```


### Instalación y carga
Seguidamente, se muestran las instrucciones para instalar y cargar estos paquetes. El paquete `graphics` forma parte de la instalación base de R, por lo que no necesita ser instalado ni cargado explícitamente.

```{r paquetes-graficacion-instalacion, eval=FALSE}
# Instalación de paquetes de graficación
install.packages("ggplot2")
install.packages("plotly")
```

```{r paquetes-graficacion-carga, message=FALSE}
# Carga de paquetes de graficación
library(ggplot2)
library(plotly)
```

Adicionalmente, se cargan otros paquetes para importación y transformación de datos.

```{r paquetes-otros-carga, message=FALSE}
# Carga de otros paquetes
library(readr) # paquete para transformación de datos
library(dplyr) # paquete para transformación de datos
```

Existen muchos otros paquetes de R para graficación, entre los que pueden mencionarse:

- [lattice](http://lattice.r-forge.r-project.org/): es especialmente utilizado para datos multivariados.
- [ggvis](https://ggvis.rstudio.com/): agrega interactividad a los gráficos de `ggplot2`.
- [rgl](https://github.com/dmurdoch/rgl): para gráficos en 3D.

## Conjuntos de datos para ejemplos
Para ejemplificar el uso de estos paquetes de graficación, se utilizarán varios conjuntos de datos. En esta sección, el contenido de estos conjuntos se muestra con el paquete [DT](https://rstudio.github.io/DT/), el cual despliega data frames como tablas en HTML con capacidades de filtrado, paginación, ordenamiento y otras.

```{r dt-instalacion, eval=FALSE}
# Instalación del paquete DT
install.packages("DT")
```

```{r dt-carga, message=FALSE}
# Carga del paquete DT
library(DT)
```

Para cada conjunto de datos, se muestran los siguientes procesos del modelo de ciencia de datos: importación, transformación y visualización (en tablas).

### mtcars
[mtcars: *Motor Trend Car Road Tests*](https://rdrr.io/r/datasets/mtcars.html) contiene datos de aspectos de diseño y consumo de combustible para 32 modelos de automóviles. Es uno de los conjuntos de datos contenidos en la instalación base de R, por lo que no es necesario importarlo desde una fuente externa.

Transformación:

```{r mtcars-transformacion}
# Transformación de datos de mtcars
mtcars <-
  mtcars %>%
  select(mpg, cyl, disp, hp, wt)
```

Visualización en formato tabular:

```{r mtcars-tabla}
# Visualización de datos de mtcars en formato tabular
mtcars %>%
  datatable(options = list(
    pageLength = 5,
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')
  ))
```

### Covid-19
Estos son datos publicados por el Ministerio de Salud de Costa Rica sobre la [situación nacional de covid-19](https://geovision.uned.ac.cr/oges/). Se distribuyen en archivos CSV, algunos correspondientes al nivel nacional y otros al nivel cantonal.

#### Datos nacionales
Este conjunto de datos contiene una observación por fecha y variables correspondientes a, entre otras, las cantidades de casos positivos, fallecidos, recuperados y activos a nivel nacional.

Importación:

```{r covid-nacional-importacion, message=FALSE}
# Importación de datos nacionales de covid-19
covid_nacional <-
  read_delim(
    file = "datos/ministerio-salud/covid/05_17_22_CSV_GENERAL.csv",
    delim = ";",
    col_select = c("FECHA", "positivos", "fallecidos", "RECUPERADOS", "activos")
  )
```

Transformación:

```{r covid-nacional-transformacion}
# Transformación de datos nacionales de covid-19
covid_nacional <-
  covid_nacional %>%
  select(fecha = FECHA,
         positivos,
         fallecidos,
         recuperados = RECUPERADOS,
         activos) %>%
  mutate(fecha = as.Date(fecha, format = "%d/%m/%Y"))
```

Visualización en formato tabular:

```{r covid-nacional-tabla}
# Visualización de datos nacionales de covid-19 en formato tabular
covid_nacional %>%
  datatable(options = list(
    pageLength = 5,
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')
  ))
```

#### Casos positivos por cantón
Este conjunto de datos contiene una observación por cantón y variables correspondientes a la cantidad de casos positivos para cada fecha. En los ejemplos siguientes, se utiliza solamente la variable correspondiente a la fecha máxima.

Importación:

```{r covid-cantones-positivos-importacion, message=FALSE}
# Importación de casos positivos de covid-19 por cantón
covid_cantonal_positivos <-
  read_delim(
    file = "datos/ministerio-salud/covid/05_17_22_CSV_POSITIVOS.csv",
    delim = ";",
    locale = locale(encoding = "WINDOWS-1252"), # esto es para resolver el problema con las tildes
    col_select = c("canton", "17/02/2022")
  )
```

Transformación:

```{r covid-cantones-positivos-transformacion}
# Transformación de casos positivos de covid-19 por cantón
covid_cantonal_positivos <-
  covid_cantonal_positivos %>%
  rename(positivos = '17/02/2022')
```

Visualización en formato tabular:

```{r covid-cantones-positivos-tabla}
# Visualización de casos positivos de covid-19 por cantón en formato tabular
covid_cantonal_positivos %>%
  datatable(options = list(
    pageLength = 5,
    language = list(url = '//cdn.datatables.net/plug-ins/1.10.11/i18n/Spanish.json')
  ))
```

## Ejemplos de gráficos

### Gráficos de dispersión
Un [gráfico de dispersión o *scatterplot*](https://es.wikipedia.org/wiki/Diagrama_de_dispersi%C3%B3n) despliega los valores de dos variables numéricas de un conjunto de datos, como puntos en un sistema de coordenadas. El valor de una variable se despliega en el eje X y el de la otra variable en el eje Y. Variables adicionales pueden ser mostradas mediante atributos de los puntos, tales como tamaño, color y forma.

Los siguientes gráficos de dispersión presentan la relación entre las variables `wt` (peso en miles de libras) y `mpg` (rendimiento en millas por galón de combustible) del conjunto de datos `mtcars`.

#### graphics

```{r graphics-dispersion}
# graphics - gráfico de dispersión
plot(
  x = mtcars$wt,
  y = mtcars$mpg,
  main = "Peso vs. rendimiento de automóviles",
  xlab = "Peso (miles de libras)",
  ylab = "Rendimiento (millas por galón de combustible)",
  col = mtcars$cyl
)
```

#### ggplot2

```{r ggplot2-dispersion}
# ggplot2 - gráfico de dispersión
ggplot2_mtcars_dispersion <-
  mtcars %>%
  ggplot(aes(x = wt, y = mpg)) +
  geom_point(aes(color = factor(cyl))) +
  ggtitle("Peso vs. rendimiento de automóviles") +
  xlab("Peso (miles de libras)") +
  ylab("Rendimiento (millas por galón de combustible)") +
  labs(color = "Cilindros")

ggplot2_mtcars_dispersion
```

#### plotly

```{r plotly-dispersion, message=FALSE}
# plotly - gráfico de dispersión
mtcars %>%
  plot_ly(x = ~ wt,
          y = ~ mpg,
          color = ~ factor(cyl)) %>% layout(
            title = "Peso vs. rendimiento de automóviles",
            xaxis = list(title = "Peso (miles de libras)"),
            yaxis = list(title = "Rendimiento (millas por galón de combustible)")
          ) %>% layout(legend = list(title = list(text = "Cilindros"))) %>% config(locale = 'es')
```

#### ggplotly

```{r ggplotly-dispersion, message=FALSE}
# ggplotly - gráfico de dispersión
ggplotly(ggplot2_mtcars_dispersion) %>% config(locale = 'es')
```

### Gráficos de línea
Un [gráfico de línea](https://en.wikipedia.org/wiki/Line_chart) muestra información en la forma de puntos de datos, llamados marcadores (*markers*), conectados por segmentos de líneas rectas. Es similar a un gráfico de dispersión pero, además de los segmentos de línea, tiene la particularidad de que los datos están ordenados, usualmente con respecto al eje X. Los gráficos de línea son usados frecuentemente para mostrar tendencias a través del tiempo.

Los siguientes gráficos de línea muestran la evolución en el tiempo de los casos positivos, fallecidos, recuperados y activos de covid-19 en Costa Rica.

#### graphics

```{r graphics-linea}
# graphics - gráfico de línea
plot(
  covid_nacional$fecha,
  covid_nacional$positivos,
  type = "l",
  xaxt = "n",
  yaxt = "n",
  main = "Casos acumulados de covid-19 en Costa Rica",
  xlab = "Fecha",
  ylab = "Casos",
  col = "blue"
)

# Casos recuperados
lines(covid_nacional$fecha, covid_nacional$recuperados, col="green")

# Casos activos
lines(covid_nacional$fecha, covid_nacional$activos, col="red")

# Casos fallecidos
lines(covid_nacional$fecha, covid_nacional$fallecidos, col="black")

# Leyenda
legend(
  x = "topleft",
  inset = 0.03,
  legend = c("Positivos", "Recuperados", "Activos", "Fallecidos"),
  col = c("blue", "green", "red", "black"),
  lty = 1,
  cex = 0.7)

# Formato del eje X
axis(side = 1,
     covid_nacional$fecha,
     tick = FALSE,
     format(covid_nacional$fecha, "%m-%y"),
     cex.axis = .7)

# Formato del eje Y
axis(
  side = 2,
  covid_nacional$positivos,
  labels = TRUE,  
  at = seq(0, 1000000, by = 200000),
  cex.axis = .7
)
```

#### ggplot2

```{r ggplot2-linea}
# ggplot2 - gráfico de línea
ggplot2_covid_nacional_linea <-
  covid_nacional %>%
  ggplot(aes(x = fecha, y = value, color = variable)) +
  ggtitle("Casos acumulados de covid-19 en Costa Rica") +
  xlab("Fecha") +
  ylab("Casos") +
  geom_line(aes(y = positivos, color = "Positivos")) +
  geom_line(aes(y = recuperados, color = "Recuperados")) +
  geom_line(aes(y = activos, color = "Activos")) +
  geom_line(aes(y = fallecidos, color = "Fallecidos")) +
  scale_colour_manual(
    "",
    values = c(
      "Positivos" = "blue",
      "Recuperados" = "green",
      "Activos" = "red",
      "Fallecidos" = "black"
    )
  )

ggplot2_covid_nacional_linea
```

#### plotly

```{r plotly-linea}
# plotly - gráfico de línea
covid_nacional %>%
  plot_ly(
    x = ~ fecha,
    y = ~ positivos,
    name = 'Positivos',
    type = 'scatter',
    mode = 'lines',
    line = list(color = "blue")
  ) %>%
  add_trace(
    y = ~ recuperados,
    name = 'Recuperados',
    mode = 'lines',
    line = list(color = "green")
  ) %>%
  add_trace(
    y = ~ activos,
    name = 'Activos',
    mode = 'lines',
    line = list(color = "red")
  ) %>%
  add_trace(
    y = ~ fallecidos,
    name = 'Fallecidos',
    mode = 'lines',
    line = list(color = "black")
  ) %>%
  layout(
    title = "",
    yaxis = list(title = "Casos"),
    xaxis = list(title = "Fecha"),
    legend = list(x = 0.1, y = 0.9),
    hovermode = "compare"
  )
```

#### ggplotly

```{r ggplotly-linea, message=FALSE}
# ggplotly - gráfico de línea
ggplotly(ggplot2_covid_nacional_linea) %>% config(locale = 'es')
```

## Recursos de interés
*DT: An R interface to the DataTables library*. (s. f.). Recuperado 21 de mayo de 2022, de https://rstudio.github.io/DT/

Healy, Y. H. and C. (s. f.). *From data to Viz | Find the graphic you need*. Recuperado 20 de marzo de 2022, de https://www.data-to-viz.com/